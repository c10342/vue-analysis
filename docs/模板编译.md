# 模板编译阶段

HTML解析器作为主线，先用html解析器进行解析整个模板，如果在解析过程中碰见文本内容，就调用文本解析器来解析文本，如果碰到文本中包含过滤器，就调用过滤器解析器来解析

html解析器主要是调用了ParseHtml函数，分别传入了2个参数，一个是待转换的模板字符串，一个是转换时所需要的选项。第二个参数在定义一些参数的同时，还定义了4个钩子函数，这4个钩子函数就是负责吧提取出来的内容生成对应的ast。分别是start，解析到标签的开始位置是触发。end，解析到标签的结束位置时触发。chars，解析到文本的时候触发。comment，解析到标签的注释是触发

通常模板内容会包含，文本，html注释。条件注释，doctype，开始标签和结束标签。这几种内容都有其各自的特点，也就是根据这些不同内让那个所具有的不同特点编写不同的正则表达式，讲这些内容从模板字符串中解析出来

# 优化阶段

优化阶段主要做的就是两件事：意思在ast中找出所有静态节点并打上标记。二是在ast中找出所有静态根节点并打上标记

标记静态节点：
从根节点开始，先标记根节点是否为静态节点，如果根节点有子元素，就递归子元素，直到标记完所有节点，如果子节点不是一个静态节点，那么需要把子节点的父节点也标记为非静态节点。在模板编译阶段，会根据节点的类型给节点添加不同的type属性，分别标记为元素节点，包含变量的动态文本节点，不包含变量的纯文本节点。如果是包含变量的动态文本节点，那么肯定不是静态节点。如果是不包含变量的纯文本节点，那么肯定就是静态节点。如果是元素节点，要满足一下要求才能是静态节点，如果节点使用了`v-pre`指令，那么断定是静态节点，如果没有使用到`v-pre`指令，那要满足一下条件才能是静态节点，一是不能使用动态绑定语法，及标签上不能有`v-`，`@`，`:`开头的属性，二是不能使用`v-if`，`v-for`等指令，三是不能为内置组件，即标签名不能为`slot`和`component`，四是标签名必须是平台保留标签，既不能是组件，五是当前节点的父节点不能是带有`v-for`的`template`标签。

标记静态根节点：

一个节点要成为静态根节点，就必须满足一下要求：一是节点本身必须是静态节点，二是必须拥有子节点，三是子节点不能只是只有一个文本节点

# 代码生成阶段

代码生成阶段就是要生成render函数字符串。

v-if和v-for，在代码生成阶段，不同指令和内容处理的优先级是不一样的。优先级如下：静态节点，v-once指令，v-for指令，v-if指令，template包裹的子节点，插槽